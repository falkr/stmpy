<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>stmpy API documentation</title>
    <meta name="description" content="Module `stmpy` provides support for state machines in Python.

## Contributing

`stmpy` [is on GitHu..." />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>

  <style type="text/css">
  .codehilite .hll { background-color: #ffffcc }
.codehilite  { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #0000FF } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>

  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#stmpy.get_graphviz_dot">get_graphviz_dot</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#stmpy.Driver">Driver</a></span>
        
          
  <ul>
    <li class="mono"><a href="#stmpy.Driver.__init__">__init__</a></li>
    <li class="mono"><a href="#stmpy.Driver.add_machine">add_machine</a></li>
    <li class="mono"><a href="#stmpy.Driver.print_status">print_status</a></li>
    <li class="mono"><a href="#stmpy.Driver.send_signal">send_signal</a></li>
    <li class="mono"><a href="#stmpy.Driver.start">start</a></li>
    <li class="mono"><a href="#stmpy.Driver.step">step</a></li>
    <li class="mono"><a href="#stmpy.Driver.stop">stop</a></li>
    <li class="mono"><a href="#stmpy.Driver.wait_until_finished">wait_until_finished</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#stmpy.Machine">Machine</a></span>
        
          
  <ul>
    <li class="mono"><a href="#stmpy.Machine.__init__">__init__</a></li>
    <li class="mono"><a href="#stmpy.Machine.get_timer">get_timer</a></li>
    <li class="mono"><a href="#stmpy.Machine.send_signal">send_signal</a></li>
    <li class="mono"><a href="#stmpy.Machine.start_timer">start_timer</a></li>
    <li class="mono"><a href="#stmpy.Machine.stop_timer">stop_timer</a></li>
    <li class="mono"><a href="#stmpy.Machine.terminate">terminate</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">stmpy</span> module</h1>
  <p>Module <code>stmpy</code> provides support for state machines in Python.</p>
<h2>Contributing</h2>
<p><code>stmpy</code> <a href="https://github.com/falkr/stmpy">is on GitHub</a>. Pull
requests and bug reports are welcome.</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy', this);">Show source &equiv;</a></p>
  <div id="source-stmpy" class="source">
    <div class="codehilite"><pre><span></span><span class="sd">&quot;&quot;&quot;Module `stmpy` provides support for state machines in Python.</span>

<span class="sd">## Contributing</span>

<span class="sd">`stmpy` [is on GitHub](https://github.com/falkr/stmpy). Pull</span>
<span class="sd">requests and bug reports are welcome.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>


<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;0.6.2&#39;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The current version of stmpy.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">_print_action</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;event_args&#39;</span><span class="p">]:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;(*)&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
        <span class="n">first</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
                <span class="n">first</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_print_state</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{} [shape=plaintext margin=0 label=&lt;&lt;TABLE BORDER=&quot;1&quot; CELLBORDER=&quot;0&quot; CELLSPACING=&quot;0&quot; STYLE=&quot;ROUNDED&quot;&gt;&lt;TR&gt;&lt;TD&gt;&lt;B&gt;{}&lt;/B&gt;&lt;/TD&gt;&lt;/TR&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">entry</span> <span class="ow">or</span> <span class="n">state</span><span class="o">.</span><span class="n">exit</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;HR/&gt;&#39;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;TR&gt;&lt;TD ALIGN=&quot;LEFT&quot;&gt;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">entry</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;entry / {}&lt;BR/&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_print_action</span><span class="p">(</span><span class="n">entry</span><span class="p">)))</span>
        <span class="k">for</span> <span class="nb">exit</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">exit</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;exit / {}&lt;BR/&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_print_action</span><span class="p">(</span><span class="nb">exit</span><span class="p">)))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;/TD&gt;&lt;/TR&gt;&#39;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;/TABLE&gt;&gt;];&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_print_transition</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">counter</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">trigger</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">trigger</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">effect</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="s1">&#39; /&#39;</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">trigger</span><span class="p">:</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span>
        <span class="k">for</span> <span class="n">effect</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">effect</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;{};</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_print_action</span><span class="p">(</span><span class="n">effect</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">):</span> <span class="c1"># we have a compound transition</span>
        <span class="n">decision_name</span> <span class="o">=</span> <span class="s1">&#39;d_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{} -&gt; {} [label=&quot;{}()&quot;]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">decision_name</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{} [shape=diamond, style=filled, label=&quot;&quot;, fillcolor=black, height=0.3, width=0.3, fixedsize=true]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">decision_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;targets&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{} -&gt; {}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">decision_name</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{} -&gt; {} [label=&quot; {}&quot;]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_graphviz_dot</span><span class="p">(</span><span class="n">machine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the graph of the state machine.</span>

<span class="sd">    The format is the dot format for Graphviz, and can be directly used as input</span>
<span class="sd">    to Graphviz.</span>

<span class="sd">    To learn more about Graphviz, visit https://graphviz.gitlab.io.</span>

<span class="sd">    **Display in Jupyter Notebook**</span>
<span class="sd">    Install Python support for Graphviz via `pip install graphviz`.</span>
<span class="sd">    Install Graphviz.</span>
<span class="sd">    In a notebook, build a stmpy.Machine. Then, declare a cell with the</span>
<span class="sd">    following content:</span>

<span class="sd">        from graphviz import Source</span>
<span class="sd">        src = Source(stmpy.get_graphviz_dot(stm))</span>
<span class="sd">        src</span>

<span class="sd">    **Using Graphviz on the Command Line**</span>

<span class="sd">    Write the graph file with the following code:</span>

<span class="sd">        with open(&quot;graph.gv&quot;, &quot;w&quot;) as file:</span>
<span class="sd">        print(stmpy.get_graphviz_dot(stm), file=file)</span>

<span class="sd">    You can now use the command line tools from Graphviz to create a graphic</span>
<span class="sd">    file with the graph. For instance:</span>

<span class="sd">        dot -Tsvg graph.gv -o graph.svg</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;digraph G {</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;node [shape=box style=rounded fontname=Helvetica];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;edge [ fontname=Helvetica ];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># initial state</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;initial [shape=point width=0.2];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">state_name</span> <span class="ow">in</span> <span class="n">machine</span><span class="o">.</span><span class="n">_states</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_state</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">_states</span><span class="p">[</span><span class="n">state_name</span><span class="p">]))</span>
    <span class="c1"># initial transition</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_transition</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">_intial_transition</span><span class="p">,</span> <span class="n">counter</span><span class="p">))</span>
    <span class="o">++</span><span class="n">counter</span>
    <span class="k">for</span> <span class="n">t_id</span> <span class="ow">in</span> <span class="n">machine</span><span class="o">.</span><span class="n">_table</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_transition</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">_table</span><span class="p">[</span><span class="n">t_id</span><span class="p">],</span> <span class="n">counter</span><span class="p">))</span>
        <span class="o">++</span><span class="n">counter</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_parse_arg_list</span><span class="p">(</span><span class="n">arglist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses a list of arguments.</span>

<span class="sd">    Arguments are expected to be split by a comma, surrounded by any amount</span>
<span class="sd">    of whitespace. Arguments are then run through Python&#39;s eval() method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arglist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">arg</span><span class="p">:</span> <span class="c1"># string is not empty</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">args</span>

<span class="k">def</span> <span class="nf">_parse_action</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses a single action item, for instance one of the following:</span>

<span class="sd">        m; m(); m(True); m(*)</span>

<span class="sd">    The brackets must match.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i_open</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i_open</span> <span class="ow">is</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># return action name, finished</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;event_args&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
    <span class="c1"># we need to parse the arguments</span>
    <span class="n">i_close</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i_close</span> <span class="ow">is</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Bracket in argument opened but not closed.&#39;</span><span class="p">)</span>
    <span class="n">action_name</span> <span class="o">=</span> <span class="n">action</span><span class="p">[:</span><span class="n">i_open</span><span class="p">]</span>
    <span class="n">arglist</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="n">i_open</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i_close</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arglist</span><span class="p">:</span>
        <span class="c1"># no arglist, just return method name</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">action_name</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;event_args&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
    <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">arglist</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">action_name</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;event_args&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">action_name</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">_parse_arg_list</span><span class="p">(</span><span class="n">arglist</span><span class="p">),</span> <span class="s1">&#39;event_args&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">_parse_action_list_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses a list of actions, as found in the effect attribute of</span>
<span class="sd">    transitions, and the enry and exit actions of states.</span>

<span class="sd">    Actions are separated by a semicolon, surrounded by any amount of</span>
<span class="sd">    whitespace. A action can have the following form:</span>

<span class="sd">        m; m(); m(True); m(*)</span>

<span class="sd">    The asterisk that the state machine should provide the args and</span>
<span class="sd">    kwargs from the incoming event.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">action_call</span> <span class="ow">in</span> <span class="n">attribute</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
        <span class="n">action_call</span> <span class="o">=</span> <span class="n">action_call</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">action_call</span><span class="p">:</span> <span class="c1"># string is not empty</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_parse_action</span><span class="p">(</span><span class="n">action_call</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">actions</span>

<span class="k">def</span> <span class="nf">_is_state_machine_method</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;start_timer&#39;</span><span class="p">,</span> <span class="s1">&#39;stop_timer&#39;</span><span class="p">,</span> <span class="s1">&#39;send_signal&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_current_time_millis</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_tid</span><span class="p">(</span><span class="n">state_id</span><span class="p">,</span> <span class="n">event_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">state_id</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">event_id</span>


<span class="k">class</span> <span class="nc">Driver</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A driver can run several  machines.</span>

<span class="sd">    **Run-to-completion:**</span>
<span class="sd">    One driver contains one thread. Machines assigned to a driver are executed</span>
<span class="sd">    within this single thread. This provides a strict temporal ordering of</span>
<span class="sd">    behavior for state machines assigned to the same driver. A driver only</span>
<span class="sd">    executes one transition at a time, and always executes this transition to</span>
<span class="sd">    completion. This means that the action within a transition can access</span>
<span class="sd">    shared variables without interleaving behavior. One transition is always</span>
<span class="sd">    executed separate from all other transitions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_stms_by_id</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new driver.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Logging works&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_timeout</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># TODO need clarity if this should be a class variable</span>
        <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_wake_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Sends a None event to wake up the queue.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide a snapshot of the current status.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=== State Machines: ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">stm_id</span> <span class="ow">in</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">:</span>
            <span class="n">stm</span> <span class="o">=</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">[</span><span class="n">stm_id</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    - {} in state {}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stm</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">stm</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=== Events in Queue: ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">queue</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    - {} for {} with args:{} kwargs:{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">event</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;stm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">event</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=== Active Timers: {} ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">timer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    - {} for {} with timeout {}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;stm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=== ================ ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_machine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the state machine to this driver.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding machine {} to driver&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="n">machine</span><span class="o">.</span><span class="n">_driver</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">machine</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">machine</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># TODO warning when STM already registered</span>
            <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">[</span><span class="n">machine</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">machine</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">stm</span><span class="o">=</span><span class="n">machine</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_transitions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">keep_active</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the driver.</span>

<span class="sd">        This method creates a thread which runs the event loop.</span>
<span class="sd">        The method returns immediately. To wait until the driver</span>
<span class="sd">        finishes, use `stmpy.Driver.wait_until_finished`.</span>

<span class="sd">        `max_transitions`: execute only this number of transitions, then stop</span>
<span class="sd">        `keep_active`: When true, keep the driver running even when all state</span>
<span class="sd">        machines terminated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_transitions</span> <span class="o">=</span> <span class="n">max_transitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keep_active</span> <span class="o">=</span> <span class="n">keep_active</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a single step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">max_transitions</span><span class="o">=</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_finished</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the driver.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wake_queue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">wait_until_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Blocking method to wait until the driver finished its execution.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Keyboard interrupt detected, stopping driver.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wake_queue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_sort_timer_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">timer</span><span class="p">:</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;timeout_abs&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_start_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">stm</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start timer with name={} from stm={}&#39;</span>
                           <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">stm</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="n">timeout_abs</span> <span class="o">=</span> <span class="n">_current_time_millis</span><span class="p">()</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_timer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">stm</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">timeout</span><span class="p">,</span> <span class="s1">&#39;timeout_abs&#39;</span><span class="p">:</span> <span class="n">timeout_abs</span><span class="p">,</span>
             <span class="s1">&#39;stm&#39;</span><span class="p">:</span> <span class="n">stm</span><span class="p">,</span> <span class="s1">&#39;tid&#39;</span><span class="p">:</span> <span class="n">stm</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sort_timer_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wake_queue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_stop_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">stm</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stopping timer with name={} from stm={}&#39;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">stm</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">index_to_delete</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">tid</span> <span class="o">=</span> <span class="n">stm</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">for</span> <span class="n">timer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;tid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tid</span><span class="p">:</span>
                <span class="n">index_to_delete</span> <span class="o">=</span> <span class="n">index</span>
            <span class="o">++</span><span class="n">index</span>
        <span class="k">if</span> <span class="n">index_to_delete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index_to_delete</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">stm</span><span class="p">):</span>
        <span class="n">tid</span> <span class="o">=</span> <span class="n">stm</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">for</span> <span class="n">timer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;tid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;timeout_abs&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">_current_time_millis</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_check_timers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check for expired timers.</span>

<span class="sd">        If there are any timers that expired, place them in the event</span>
<span class="sd">        queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">:</span>
            <span class="n">timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;timeout_abs&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_current_time_millis</span><span class="p">():</span>
                <span class="c1"># the timer is expired, remove first element in queue</span>
                <span class="n">popped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># put into the event queue</span>
                <span class="c1"># TODO maybe put timer first in queue?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Timer {} expired for stm {}, adding it to event queue.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;stm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="n">timer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="p">[],</span> <span class="p">{},</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;stm&#39;</span><span class="p">])</span>
                <span class="c1"># not necessary to set next timeout,</span>
                <span class="c1"># complete check timers will be called again</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_next_timeout</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;timeout_abs&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">_current_time_millis</span><span class="p">())</span> <span class="o">/</span> <span class="mi">1000</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_next_timeout</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_timeout</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">stm</span><span class="p">):</span>
        <span class="c1"># add the event to the queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">event_id</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">,</span>
                              <span class="s1">&#39;stm&#39;</span><span class="p">:</span> <span class="n">stm</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">send_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_id</span><span class="p">,</span> <span class="n">stm_id</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a signal to a state machine handled by this driver.</span>

<span class="sd">        If you have a reference to the state machine, you can also send it</span>
<span class="sd">        directly to it by using `stmpy.Machine.send_signal`.</span>

<span class="sd">        `stm_id` must be the id of a state machine earlier added to the driver.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stm_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Machine with name {} cannot be found. &#39;</span>
                              <span class="s1">&#39;Ignoring signal {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stm_id</span><span class="p">,</span> <span class="n">signal_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stm</span> <span class="o">=</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">[</span><span class="n">stm_id</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="n">signal_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">stm</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_terminate_stm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stm_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Terminating machine {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stm_id</span><span class="p">))</span>
        <span class="c1"># removing it from the table of machines</span>
        <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">stm_id</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No machines anymore, stopping driver.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wake_queue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_execute_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stm</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">stm</span><span class="o">.</span><span class="n">_execute_transition</span><span class="p">(</span><span class="n">event_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_transitions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_transitions</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_transitions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stopping driver because max_transitions reached.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_start_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting loop of the driver.&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_timers</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                              <span class="n">timeout</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_timeout</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># (None events are just used to wake up the queue.)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_execute_transition</span><span class="p">(</span><span class="n">stm</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;stm&#39;</span><span class="p">],</span>
                                             <span class="n">event_id</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                                             <span class="n">args</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span>
                                             <span class="n">kwargs</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="c1"># timeout has occured</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Timer expired, driver loop active again.&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Keyboard interrupt. Stopping the driver.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Driver loop is finished.&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements a state machine.</span>

<span class="sd">    A machine must be added to a driver to execute it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_parse_transitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transitions</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_intial_transition</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">transition_string</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">:</span>
            <span class="n">t_dict</span> <span class="o">=</span> <span class="n">transition_string</span>  <span class="c1"># ast.literal_eval(transition_string)</span>
            <span class="c1"># TODO error handling: string may be written in a wrong way</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">t_dict</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="s1">&#39;initial&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_intial_transition</span> <span class="o">=</span> <span class="n">_Transition</span><span class="p">(</span><span class="n">transition_string</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trigger</span> <span class="o">=</span> <span class="n">t_dict</span><span class="p">[</span><span class="s1">&#39;trigger&#39;</span><span class="p">]</span>
                <span class="n">t_id</span> <span class="o">=</span> <span class="n">_tid</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">trigger</span><span class="p">)</span>
                <span class="n">transition</span> <span class="o">=</span> <span class="n">_Transition</span><span class="p">(</span><span class="n">transition_string</span><span class="p">)</span>
                <span class="c1"># TODO error handling: what if several transition with same</span>
                <span class="c1"># id start from same source state?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">[</span><span class="n">t_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">transition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intial_transition</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The machine has no initial transition&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s_dict</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">s_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="c1"># TODO check that state name is given</span>
            <span class="c1"># initial state cannot be detailed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_State</span><span class="p">(</span><span class="n">s_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Create a new state machine.</span>

<span class="sd">        Throws an exception if the state machine is not well-formed.</span>

<span class="sd">        **Transitions:**</span>
<span class="sd">        Transitions are specified as a dictionary with the following key / value</span>
<span class="sd">        pairs:</span>

<span class="sd">          * trigger: string with the name of a trigger, either a signal to receive or the name of a timer.</span>
<span class="sd">          * source: string with the name of a state.</span>
<span class="sd">          * target: string with the name of a state.</span>
<span class="sd">          * effect: (optional) a set of strings that refers to method name of the object passed to the state machine via `obj`. Several effects can be separated with a `;`.</span>

<span class="sd">            #!python</span>
<span class="sd">            t_1 = {&#39;trigger&#39;: &#39;tick&#39;,</span>
<span class="sd">                   &#39;source&#39;: &#39;s_tick&#39;,</span>
<span class="sd">                   &#39;target&#39;: &#39;s_tock&#39;,</span>
<span class="sd">                   &#39;effect&#39;: &#39;on_tick&#39;}</span>

<span class="sd">        **Initial Transition:**</span>
<span class="sd">        A state machine requires a single initial transition. This is a normal</span>
<span class="sd">        transition that has a source state with name `&#39;initial&#39;`, and no</span>
<span class="sd">        trigger.</span>

<span class="sd">            #!python</span>
<span class="sd">            t_0 = {&#39;source&#39;: &#39;initial&#39;,</span>
<span class="sd">                   &#39;target&#39;: &#39;s_tick&#39;,</span>
<span class="sd">                   &#39;effect&#39;: &#39;on_init&#39;}</span>

<span class="sd">        **Compound Transitions:**</span>
<span class="sd">        A compound transition is used to declare a transition that can contain decisions.</span>
<span class="sd">        A compound transition can decide upon the target state at run-time, for instance based on data in variables.</span>
<span class="sd">        It is declared like a normal transition, but does not declare any effect or target.</span>
<span class="sd">        Instead, it refers to a function that is executed. The function must return a string that determines the target state.</span>
<span class="sd">        The key &#39;targets&#39; (notice the plural &#39;s&#39;) allows to specify the potential target states.</span>
<span class="sd">        This has no influence on the behavior of the state machine, but is just used when the data structure is also</span>
<span class="sd">        used to generate a state machine graph.</span>

<span class="sd">            #!python</span>
<span class="sd">            def transition_1(args, kwargs):</span>
<span class="sd">                # do something</span>
<span class="sd">                if ... :</span>
<span class="sd">                    return &#39;s1&#39;</span>
<span class="sd">                else:</span>
<span class="sd">                    return &#39;s2&#39;</span>

<span class="sd">            t_3 = {&#39;source&#39;: &#39;s_0&#39;,</span>
<span class="sd">                   &#39;trigger&#39;: &#39;t&#39;,</span>
<span class="sd">                   &#39;targets&#39;: &#39;s1 s2&#39;,</span>
<span class="sd">                   &#39;function&#39;: transition_1}</span>

<span class="sd">        **States:**</span>
<span class="sd">        States are specified as sources and targets as part of the transitions.</span>
<span class="sd">        This is done by simple strings.</span>

<span class="sd">        States can also declare entry and exit actions that are called when they are entered or exited.</span>
<span class="sd">        To declare these actions, declare a dictionary for the state. The name key refers to</span>
<span class="sd">        the name of the state that is also used in the transition declaration.</span>

<span class="sd">            #!python</span>
<span class="sd">            s_0 = {&#39;name&#39;: &#39;s_0&#39;,</span>
<span class="sd">                   &#39;entry&#39;: &#39;op1; op2&#39;,</span>
<span class="sd">                   &#39;exit&#39;: &#39;op3&#39;}</span>

<span class="sd">        **Actions and Effects:**</span>
<span class="sd">        The value of the attributes for transition effects and for state entry</span>
<span class="sd">        and exit actions can list several actions that are called on the object</span>
<span class="sd">        provided to the state machine.</span>

<span class="sd">        This list of actions can look in the following way:</span>

<span class="sd">            effect=&#39;m1; m2(); m3(1, True, &quot;a&quot;); m4(*)&#39;</span>

<span class="sd">        This is a semicolon-separated list of actions that are called, here as</span>
<span class="sd">        part of a transition&#39;s effect. Method m1 has no arguments, and neither</span>
<span class="sd">        does m2. This means the empty brackets are optional. Method m3 has three</span>
<span class="sd">        litteral arguments, here the integer 1, the boolean True and the string</span>
<span class="sd">        &#39;a&#39;. Note how the string is surrounded by double quotation marks, since</span>
<span class="sd">        the entire effect is coded in single quotation marks. Vice-versa is also</span>
<span class="sd">        possible. The last method, m4, declares an asterisk as argument. This</span>
<span class="sd">        means that the state machine uses the args and kwargs of the incoming</span>
<span class="sd">        event and offers them to the method.</span>

<span class="sd">        The actions can also directly refer to the state machine actions</span>
<span class="sd">        `stmpy.Machine.start_timer`, `stmpy.Machine.stop_timer`, and</span>
<span class="sd">        `stmpy.Machine.send_signal`. A transition can for instance declare the</span>
<span class="sd">        following effects:</span>

<span class="sd">            effect=&#39;start_timer(&quot;t1&quot;, 100); stop_timer(&quot;t2&quot;); send_signal(&quot;a&quot;)&#39;</span>


<span class="sd">        `name`: Name of the state machine. This name is used to send signals to it, and show its state during debugging.</span>

<span class="sd">        `transitions`: A set of transitions, as explained above. There must be at least one initial transition.</span>

<span class="sd">        `obj`: An object that encapsulates any actions called from states or transitions.</span>

<span class="sd">        `states`: Optional state declarations to add entry and exit actions to them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s1">&#39;initial&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_states</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_states</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_transitions</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the current control state of the machine.</span>

<span class="sd">        This property can be accessed for debugging only.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of this machine.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">driver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the driver this machine is attached to.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span>

    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s1">&#39;initial&#39;</span>

    <span class="k">def</span> <span class="nf">_run_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">function_name</span> <span class="o">=</span> <span class="n">function_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Running function {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Error when running function {} from machine.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">function_name</span><span class="p">),</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_state_machine_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;start_timer&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Method {} expects 2 args.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_timer</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;stop_timer&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Method {} expects 1 arg.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_timer</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Action {} is not a built-in method.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">=</span> <span class="n">scheduler</span>

    <span class="k">def</span> <span class="nf">_run_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_state_machine_method</span><span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_state_machine_function</span><span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;event_args&#39;</span><span class="p">]:</span>
                <span class="c1"># use the arguments provided by the event</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">,</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># use the static arguments provided by declaration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">,</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span> <span class="p">{})</span>

    <span class="k">def</span> <span class="nf">_enter_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Machine {} enters state {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
        <span class="c1"># execute any entry actions</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_actions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">[</span><span class="n">state</span><span class="p">]</span><span class="o">.</span><span class="n">entry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">_exit_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Machine {} exits state {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
        <span class="c1"># execute any exit actions</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_actions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">[</span><span class="n">state</span><span class="p">]</span><span class="o">.</span><span class="n">exit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">is</span> <span class="s1">&#39;initial&#39;</span><span class="p">:</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intial_transition</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t_id</span> <span class="o">=</span> <span class="n">_tid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="n">event_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Machine {} is in state {} and received &#39;</span>
                    <span class="s1">&#39;event {}, but no transition with this event is declared!&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">transition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">[</span><span class="n">t_id</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exit_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>
        <span class="c1"># execute all effects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_actions</span><span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="n">effect</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transition</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
            <span class="c1"># simple transition</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">transition</span><span class="o">.</span><span class="n">target</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># compound transitions defined in code</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">transition</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># go into the next state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enter_state</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Transition in {} from {} to {} triggered by {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">previous_state</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">event_id</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">start_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timer_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start a timer or restart an active one.</span>

<span class="sd">        The timeout is given in milliseconds. If a timer with the</span>
<span class="sd">        same name already exists, it is restarted with the specified timeout.</span>
<span class="sd">        Note that the timeout is intended as the minimum time until the timer&#39;s</span>
<span class="sd">        expiration, but may vary due to the state of the event queue and the</span>
<span class="sd">        load of the system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start timer {}in stm {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_start_timer</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timer_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop a timer.</span>

<span class="sd">        If the timer is not active, nothing happens.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stop timer {}in stm {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_stop_timer</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timer_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the remaining time for the timer.</span>

<span class="sd">        If the timer is not active, `None` is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_get_timer</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_id</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a signal to this state machine.</span>

<span class="sd">        To send a signal to a machine by its name, use</span>
<span class="sd">        `stmpy.Driver.send_signal` instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Send signal {}in stm {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signal_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span>
            <span class="n">event_id</span><span class="o">=</span><span class="n">signal_id</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">stm</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminate this state machine.</span>

<span class="sd">        This removes it from the scheduler.</span>
<span class="sd">        If this is the last state machine of the scheduler and the scheduler is</span>
<span class="sd">        not configured to stay active, this will also terminate the scheduler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_terminate_stm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_Transition</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">t_dict</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;effect&#39;</span> <span class="ow">in</span> <span class="n">t_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">effect</span> <span class="o">=</span> <span class="n">_parse_action_list_attribute</span><span class="p">(</span><span class="n">t_dict</span><span class="p">[</span><span class="s1">&#39;effect&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">effect</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;trigger&#39;</span> <span class="ow">in</span> <span class="n">t_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">t_dict</span><span class="p">[</span><span class="s1">&#39;trigger&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s1">&#39;function&#39;</span> <span class="ow">in</span> <span class="n">t_dict</span><span class="p">:</span>
            <span class="c1"># transition is defined by a function</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">t_dict</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;targets&#39;</span> <span class="ow">in</span> <span class="n">t_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">t_dict</span><span class="p">[</span><span class="s1">&#39;targets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># transition is declared in data structure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">t_dict</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_State</span><span class="p">:</span>
    <span class="c1"># TODO does not work with empty entry and exit dict entries.</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s_dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">s_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;entry&#39;</span> <span class="ow">in</span> <span class="n">s_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entry</span> <span class="o">=</span> <span class="n">_parse_action_list_attribute</span><span class="p">(</span><span class="n">s_dict</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entry</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;exit&#39;</span> <span class="ow">in</span> <span class="n">s_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">_parse_action_list_attribute</span><span class="p">(</span><span class="n">s_dict</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="stmpy.get_graphviz_dot">
    <p>def <span class="ident">get_graphviz_dot</span>(</p><p>machine)</p>
    </div>
    

    
  
    <div class="desc"><p>Return the graph of the state machine.</p>
<p>The format is the dot format for Graphviz, and can be directly used as input
to Graphviz.</p>
<p>To learn more about Graphviz, visit https://graphviz.gitlab.io.</p>
<p><strong>Display in Jupyter Notebook</strong>
Install Python support for Graphviz via <code>pip install graphviz</code>.
Install Graphviz.
In a notebook, build a stmpy.Machine. Then, declare a cell with the
following content:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">graphviz</span> <span class="kn">import</span> <span class="n">Source</span>
<span class="n">src</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">stmpy</span><span class="o">.</span><span class="n">get_graphviz_dot</span><span class="p">(</span><span class="n">stm</span><span class="p">))</span>
<span class="n">src</span>
</pre></div>


<p><strong>Using Graphviz on the Command Line</strong></p>
<p>Write the graph file with the following code:</p>
<div class="codehilite"><pre><span></span>with open(&quot;graph.gv&quot;, &quot;w&quot;) as file:
print(stmpy.get_graphviz_dot(stm), file=file)
</pre></div>


<p>You can now use the command line tools from Graphviz to create a graphic
file with the graph. For instance:</p>
<div class="codehilite"><pre><span></span>dot -Tsvg graph.gv -o graph.svg
</pre></div></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.get_graphviz_dot', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.get_graphviz_dot" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_graphviz_dot</span><span class="p">(</span><span class="n">machine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the graph of the state machine.</span>

<span class="sd">    The format is the dot format for Graphviz, and can be directly used as input</span>
<span class="sd">    to Graphviz.</span>

<span class="sd">    To learn more about Graphviz, visit https://graphviz.gitlab.io.</span>

<span class="sd">    **Display in Jupyter Notebook**</span>
<span class="sd">    Install Python support for Graphviz via `pip install graphviz`.</span>
<span class="sd">    Install Graphviz.</span>
<span class="sd">    In a notebook, build a stmpy.Machine. Then, declare a cell with the</span>
<span class="sd">    following content:</span>

<span class="sd">        from graphviz import Source</span>
<span class="sd">        src = Source(stmpy.get_graphviz_dot(stm))</span>
<span class="sd">        src</span>

<span class="sd">    **Using Graphviz on the Command Line**</span>

<span class="sd">    Write the graph file with the following code:</span>

<span class="sd">        with open(&quot;graph.gv&quot;, &quot;w&quot;) as file:</span>
<span class="sd">        print(stmpy.get_graphviz_dot(stm), file=file)</span>

<span class="sd">    You can now use the command line tools from Graphviz to create a graphic</span>
<span class="sd">    file with the graph. For instance:</span>

<span class="sd">        dot -Tsvg graph.gv -o graph.svg</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;digraph G {</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;node [shape=box style=rounded fontname=Helvetica];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;edge [ fontname=Helvetica ];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># initial state</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;initial [shape=point width=0.2];</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">state_name</span> <span class="ow">in</span> <span class="n">machine</span><span class="o">.</span><span class="n">_states</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_state</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">_states</span><span class="p">[</span><span class="n">state_name</span><span class="p">]))</span>
    <span class="c1"># initial transition</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_transition</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">_intial_transition</span><span class="p">,</span> <span class="n">counter</span><span class="p">))</span>
    <span class="o">++</span><span class="n">counter</span>
    <span class="k">for</span> <span class="n">t_id</span> <span class="ow">in</span> <span class="n">machine</span><span class="o">.</span><span class="n">_table</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_print_transition</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">_table</span><span class="p">[</span><span class="n">t_id</span><span class="p">],</span> <span class="n">counter</span><span class="p">))</span>
        <span class="o">++</span><span class="n">counter</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  

    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="stmpy.Driver" class="name">class <span class="ident">Driver</span></p>
      
  
    <div class="desc"><p>A driver can run several  machines.</p>
<p><strong>Run-to-completion:</strong>
One driver contains one thread. Machines assigned to a driver are executed
within this single thread. This provides a strict temporal ordering of
behavior for state machines assigned to the same driver. A driver only
executes one transition at a time, and always executes this transition to
completion. This means that the action within a transition can access
shared variables without interleaving behavior. One transition is always
executed separate from all other transitions.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Driver', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Driver" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Driver</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A driver can run several  machines.</span>

<span class="sd">    **Run-to-completion:**</span>
<span class="sd">    One driver contains one thread. Machines assigned to a driver are executed</span>
<span class="sd">    within this single thread. This provides a strict temporal ordering of</span>
<span class="sd">    behavior for state machines assigned to the same driver. A driver only</span>
<span class="sd">    executes one transition at a time, and always executes this transition to</span>
<span class="sd">    completion. This means that the action within a transition can access</span>
<span class="sd">    shared variables without interleaving behavior. One transition is always</span>
<span class="sd">    executed separate from all other transitions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_stms_by_id</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new driver.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Logging works&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_timeout</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># TODO need clarity if this should be a class variable</span>
        <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_wake_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Sends a None event to wake up the queue.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide a snapshot of the current status.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=== State Machines: ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">stm_id</span> <span class="ow">in</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">:</span>
            <span class="n">stm</span> <span class="o">=</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">[</span><span class="n">stm_id</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    - {} in state {}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stm</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">stm</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=== Events in Queue: ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">queue</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    - {} for {} with args:{} kwargs:{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">event</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;stm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">event</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=== Active Timers: {} ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">timer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    - {} for {} with timeout {}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;stm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=== ================ ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_machine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the state machine to this driver.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding machine {} to driver&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="n">machine</span><span class="o">.</span><span class="n">_driver</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">machine</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">machine</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># TODO warning when STM already registered</span>
            <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">[</span><span class="n">machine</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">machine</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">stm</span><span class="o">=</span><span class="n">machine</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_transitions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">keep_active</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the driver.</span>

<span class="sd">        This method creates a thread which runs the event loop.</span>
<span class="sd">        The method returns immediately. To wait until the driver</span>
<span class="sd">        finishes, use `stmpy.Driver.wait_until_finished`.</span>

<span class="sd">        `max_transitions`: execute only this number of transitions, then stop</span>
<span class="sd">        `keep_active`: When true, keep the driver running even when all state</span>
<span class="sd">        machines terminated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_transitions</span> <span class="o">=</span> <span class="n">max_transitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keep_active</span> <span class="o">=</span> <span class="n">keep_active</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a single step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">max_transitions</span><span class="o">=</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_finished</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the driver.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wake_queue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">wait_until_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Blocking method to wait until the driver finished its execution.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Keyboard interrupt detected, stopping driver.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wake_queue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_sort_timer_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">timer</span><span class="p">:</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;timeout_abs&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_start_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">stm</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start timer with name={} from stm={}&#39;</span>
                           <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">stm</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="n">timeout_abs</span> <span class="o">=</span> <span class="n">_current_time_millis</span><span class="p">()</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_timer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">stm</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">timeout</span><span class="p">,</span> <span class="s1">&#39;timeout_abs&#39;</span><span class="p">:</span> <span class="n">timeout_abs</span><span class="p">,</span>
             <span class="s1">&#39;stm&#39;</span><span class="p">:</span> <span class="n">stm</span><span class="p">,</span> <span class="s1">&#39;tid&#39;</span><span class="p">:</span> <span class="n">stm</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sort_timer_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wake_queue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_stop_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">stm</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stopping timer with name={} from stm={}&#39;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">stm</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">index_to_delete</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">tid</span> <span class="o">=</span> <span class="n">stm</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">for</span> <span class="n">timer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;tid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tid</span><span class="p">:</span>
                <span class="n">index_to_delete</span> <span class="o">=</span> <span class="n">index</span>
            <span class="o">++</span><span class="n">index</span>
        <span class="k">if</span> <span class="n">index_to_delete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index_to_delete</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">stm</span><span class="p">):</span>
        <span class="n">tid</span> <span class="o">=</span> <span class="n">stm</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">for</span> <span class="n">timer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;tid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;timeout_abs&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">_current_time_millis</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_check_timers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check for expired timers.</span>

<span class="sd">        If there are any timers that expired, place them in the event</span>
<span class="sd">        queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">:</span>
            <span class="n">timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;timeout_abs&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_current_time_millis</span><span class="p">():</span>
                <span class="c1"># the timer is expired, remove first element in queue</span>
                <span class="n">popped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># put into the event queue</span>
                <span class="c1"># TODO maybe put timer first in queue?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Timer {} expired for stm {}, adding it to event queue.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;stm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="n">timer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="p">[],</span> <span class="p">{},</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;stm&#39;</span><span class="p">])</span>
                <span class="c1"># not necessary to set next timeout,</span>
                <span class="c1"># complete check timers will be called again</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_next_timeout</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;timeout_abs&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">_current_time_millis</span><span class="p">())</span> <span class="o">/</span> <span class="mi">1000</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_next_timeout</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_timeout</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">stm</span><span class="p">):</span>
        <span class="c1"># add the event to the queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">event_id</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">,</span>
                              <span class="s1">&#39;stm&#39;</span><span class="p">:</span> <span class="n">stm</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">send_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_id</span><span class="p">,</span> <span class="n">stm_id</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a signal to a state machine handled by this driver.</span>

<span class="sd">        If you have a reference to the state machine, you can also send it</span>
<span class="sd">        directly to it by using `stmpy.Machine.send_signal`.</span>

<span class="sd">        `stm_id` must be the id of a state machine earlier added to the driver.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stm_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Machine with name {} cannot be found. &#39;</span>
                              <span class="s1">&#39;Ignoring signal {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stm_id</span><span class="p">,</span> <span class="n">signal_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stm</span> <span class="o">=</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">[</span><span class="n">stm_id</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="n">signal_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">stm</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_terminate_stm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stm_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Terminating machine {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stm_id</span><span class="p">))</span>
        <span class="c1"># removing it from the table of machines</span>
        <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">stm_id</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No machines anymore, stopping driver.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wake_queue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_execute_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stm</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">stm</span><span class="o">.</span><span class="n">_execute_transition</span><span class="p">(</span><span class="n">event_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_transitions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_transitions</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_transitions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stopping driver because max_transitions reached.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_start_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting loop of the driver.&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_timers</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                              <span class="n">timeout</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_timeout</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># (None events are just used to wake up the queue.)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_execute_transition</span><span class="p">(</span><span class="n">stm</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;stm&#39;</span><span class="p">],</span>
                                             <span class="n">event_id</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                                             <span class="n">args</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span>
                                             <span class="n">kwargs</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="c1"># timeout has occured</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Timer expired, driver loop active again.&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Keyboard interrupt. Stopping the driver.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Driver loop is finished.&#39;</span><span class="p">)</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#stmpy.Driver">Driver</a></li>
          <li>builtins.object</li>
          </ul>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="stmpy.Driver.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Create a new driver.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Driver.__init__', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Driver.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a new driver.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Logging works&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_next_timeout</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># TODO need clarity if this should be a class variable</span>
    <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="stmpy.Driver.add_machine">
    <p>def <span class="ident">add_machine</span>(</p><p>self, machine)</p>
    </div>
    

    
  
    <div class="desc"><p>Add the state machine to this driver.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Driver.add_machine', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Driver.add_machine" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">add_machine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add the state machine to this driver.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding machine {} to driver&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">_driver</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">machine</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># TODO warning when STM already registered</span>
        <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">[</span><span class="n">machine</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">machine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">stm</span><span class="o">=</span><span class="n">machine</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="stmpy.Driver.print_status">
    <p>def <span class="ident">print_status</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Provide a snapshot of the current status.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Driver.print_status', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Driver.print_status" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">print_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provide a snapshot of the current status.&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=== State Machines: ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">stm_id</span> <span class="ow">in</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">:</span>
        <span class="n">stm</span> <span class="o">=</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">[</span><span class="n">stm_id</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    - {} in state {}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stm</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">stm</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=== Events in Queue: ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_queue</span><span class="o">.</span><span class="n">queue</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    - {} for {} with args:{} kwargs:{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">event</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;stm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">event</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]))</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=== Active Timers: {} ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">timer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_queue</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    - {} for {} with timeout {}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;stm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]))</span>
    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=== ================ ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="stmpy.Driver.send_signal">
    <p>def <span class="ident">send_signal</span>(</p><p>self, signal_id, stm_id, args=[], kwargs={})</p>
    </div>
    

    
  
    <div class="desc"><p>Send a signal to a state machine handled by this driver.</p>
<p>If you have a reference to the state machine, you can also send it
directly to it by using <a href="#stmpy.Machine.send_signal"><code>send_signal</code></a>.</p>
<p><code>stm_id</code> must be the id of a state machine earlier added to the driver.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Driver.send_signal', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Driver.send_signal" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">send_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_id</span><span class="p">,</span> <span class="n">stm_id</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a signal to a state machine handled by this driver.</span>
<span class="sd">    If you have a reference to the state machine, you can also send it</span>
<span class="sd">    directly to it by using `stmpy.Machine.send_signal`.</span>
<span class="sd">    `stm_id` must be the id of a state machine earlier added to the driver.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">stm_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Machine with name {} cannot be found. &#39;</span>
                          <span class="s1">&#39;Ignoring signal {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stm_id</span><span class="p">,</span> <span class="n">signal_id</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stm</span> <span class="o">=</span> <span class="n">Driver</span><span class="o">.</span><span class="n">_stms_by_id</span><span class="p">[</span><span class="n">stm_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="n">signal_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">stm</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="stmpy.Driver.start">
    <p>def <span class="ident">start</span>(</p><p>self, max_transitions=None, keep_active=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Start the driver.</p>
<p>This method creates a thread which runs the event loop.
The method returns immediately. To wait until the driver
finishes, use <a href="#stmpy.Driver.wait_until_finished"><code>wait_until_finished</code></a>.</p>
<p><code>max_transitions</code>: execute only this number of transitions, then stop
<code>keep_active</code>: When true, keep the driver running even when all state
machines terminated</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Driver.start', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Driver.start" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_transitions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">keep_active</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start the driver.</span>
<span class="sd">    This method creates a thread which runs the event loop.</span>
<span class="sd">    The method returns immediately. To wait until the driver</span>
<span class="sd">    finishes, use `stmpy.Driver.wait_until_finished`.</span>
<span class="sd">    `max_transitions`: execute only this number of transitions, then stop</span>
<span class="sd">    `keep_active`: When true, keep the driver running even when all state</span>
<span class="sd">    machines terminated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_max_transitions</span> <span class="o">=</span> <span class="n">max_transitions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_keep_active</span> <span class="o">=</span> <span class="n">keep_active</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_loop</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="stmpy.Driver.step">
    <p>def <span class="ident">step</span>(</p><p>self, steps=1)</p>
    </div>
    

    
  
    <div class="desc"><p>Execute a single step.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Driver.step', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Driver.step" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Execute a single step.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">max_transitions</span><span class="o">=</span><span class="n">steps</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_finished</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="stmpy.Driver.stop">
    <p>def <span class="ident">stop</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Stop the driver.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Driver.stop', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Driver.stop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stop the driver.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_wake_queue</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="stmpy.Driver.wait_until_finished">
    <p>def <span class="ident">wait_until_finished</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Blocking method to wait until the driver finished its execution.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Driver.wait_until_finished', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Driver.wait_until_finished" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">wait_until_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Blocking method to wait until the driver finished its execution.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Keyboard interrupt detected, stopping driver.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wake_queue</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="stmpy.Machine" class="name">class <span class="ident">Machine</span></p>
      
  
    <div class="desc"><p>Implements a state machine.</p>
<p>A machine must be added to a driver to execute it.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Machine', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Machine" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements a state machine.</span>

<span class="sd">    A machine must be added to a driver to execute it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_parse_transitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transitions</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_intial_transition</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">transition_string</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">:</span>
            <span class="n">t_dict</span> <span class="o">=</span> <span class="n">transition_string</span>  <span class="c1"># ast.literal_eval(transition_string)</span>
            <span class="c1"># TODO error handling: string may be written in a wrong way</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">t_dict</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="s1">&#39;initial&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_intial_transition</span> <span class="o">=</span> <span class="n">_Transition</span><span class="p">(</span><span class="n">transition_string</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trigger</span> <span class="o">=</span> <span class="n">t_dict</span><span class="p">[</span><span class="s1">&#39;trigger&#39;</span><span class="p">]</span>
                <span class="n">t_id</span> <span class="o">=</span> <span class="n">_tid</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">trigger</span><span class="p">)</span>
                <span class="n">transition</span> <span class="o">=</span> <span class="n">_Transition</span><span class="p">(</span><span class="n">transition_string</span><span class="p">)</span>
                <span class="c1"># TODO error handling: what if several transition with same</span>
                <span class="c1"># id start from same source state?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">[</span><span class="n">t_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">transition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intial_transition</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The machine has no initial transition&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s_dict</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">s_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="c1"># TODO check that state name is given</span>
            <span class="c1"># initial state cannot be detailed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_State</span><span class="p">(</span><span class="n">s_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Create a new state machine.</span>

<span class="sd">        Throws an exception if the state machine is not well-formed.</span>

<span class="sd">        **Transitions:**</span>
<span class="sd">        Transitions are specified as a dictionary with the following key / value</span>
<span class="sd">        pairs:</span>

<span class="sd">          * trigger: string with the name of a trigger, either a signal to receive or the name of a timer.</span>
<span class="sd">          * source: string with the name of a state.</span>
<span class="sd">          * target: string with the name of a state.</span>
<span class="sd">          * effect: (optional) a set of strings that refers to method name of the object passed to the state machine via `obj`. Several effects can be separated with a `;`.</span>

<span class="sd">            #!python</span>
<span class="sd">            t_1 = {&#39;trigger&#39;: &#39;tick&#39;,</span>
<span class="sd">                   &#39;source&#39;: &#39;s_tick&#39;,</span>
<span class="sd">                   &#39;target&#39;: &#39;s_tock&#39;,</span>
<span class="sd">                   &#39;effect&#39;: &#39;on_tick&#39;}</span>

<span class="sd">        **Initial Transition:**</span>
<span class="sd">        A state machine requires a single initial transition. This is a normal</span>
<span class="sd">        transition that has a source state with name `&#39;initial&#39;`, and no</span>
<span class="sd">        trigger.</span>

<span class="sd">            #!python</span>
<span class="sd">            t_0 = {&#39;source&#39;: &#39;initial&#39;,</span>
<span class="sd">                   &#39;target&#39;: &#39;s_tick&#39;,</span>
<span class="sd">                   &#39;effect&#39;: &#39;on_init&#39;}</span>

<span class="sd">        **Compound Transitions:**</span>
<span class="sd">        A compound transition is used to declare a transition that can contain decisions.</span>
<span class="sd">        A compound transition can decide upon the target state at run-time, for instance based on data in variables.</span>
<span class="sd">        It is declared like a normal transition, but does not declare any effect or target.</span>
<span class="sd">        Instead, it refers to a function that is executed. The function must return a string that determines the target state.</span>
<span class="sd">        The key &#39;targets&#39; (notice the plural &#39;s&#39;) allows to specify the potential target states.</span>
<span class="sd">        This has no influence on the behavior of the state machine, but is just used when the data structure is also</span>
<span class="sd">        used to generate a state machine graph.</span>

<span class="sd">            #!python</span>
<span class="sd">            def transition_1(args, kwargs):</span>
<span class="sd">                # do something</span>
<span class="sd">                if ... :</span>
<span class="sd">                    return &#39;s1&#39;</span>
<span class="sd">                else:</span>
<span class="sd">                    return &#39;s2&#39;</span>

<span class="sd">            t_3 = {&#39;source&#39;: &#39;s_0&#39;,</span>
<span class="sd">                   &#39;trigger&#39;: &#39;t&#39;,</span>
<span class="sd">                   &#39;targets&#39;: &#39;s1 s2&#39;,</span>
<span class="sd">                   &#39;function&#39;: transition_1}</span>

<span class="sd">        **States:**</span>
<span class="sd">        States are specified as sources and targets as part of the transitions.</span>
<span class="sd">        This is done by simple strings.</span>

<span class="sd">        States can also declare entry and exit actions that are called when they are entered or exited.</span>
<span class="sd">        To declare these actions, declare a dictionary for the state. The name key refers to</span>
<span class="sd">        the name of the state that is also used in the transition declaration.</span>

<span class="sd">            #!python</span>
<span class="sd">            s_0 = {&#39;name&#39;: &#39;s_0&#39;,</span>
<span class="sd">                   &#39;entry&#39;: &#39;op1; op2&#39;,</span>
<span class="sd">                   &#39;exit&#39;: &#39;op3&#39;}</span>

<span class="sd">        **Actions and Effects:**</span>
<span class="sd">        The value of the attributes for transition effects and for state entry</span>
<span class="sd">        and exit actions can list several actions that are called on the object</span>
<span class="sd">        provided to the state machine.</span>

<span class="sd">        This list of actions can look in the following way:</span>

<span class="sd">            effect=&#39;m1; m2(); m3(1, True, &quot;a&quot;); m4(*)&#39;</span>

<span class="sd">        This is a semicolon-separated list of actions that are called, here as</span>
<span class="sd">        part of a transition&#39;s effect. Method m1 has no arguments, and neither</span>
<span class="sd">        does m2. This means the empty brackets are optional. Method m3 has three</span>
<span class="sd">        litteral arguments, here the integer 1, the boolean True and the string</span>
<span class="sd">        &#39;a&#39;. Note how the string is surrounded by double quotation marks, since</span>
<span class="sd">        the entire effect is coded in single quotation marks. Vice-versa is also</span>
<span class="sd">        possible. The last method, m4, declares an asterisk as argument. This</span>
<span class="sd">        means that the state machine uses the args and kwargs of the incoming</span>
<span class="sd">        event and offers them to the method.</span>

<span class="sd">        The actions can also directly refer to the state machine actions</span>
<span class="sd">        `stmpy.Machine.start_timer`, `stmpy.Machine.stop_timer`, and</span>
<span class="sd">        `stmpy.Machine.send_signal`. A transition can for instance declare the</span>
<span class="sd">        following effects:</span>

<span class="sd">            effect=&#39;start_timer(&quot;t1&quot;, 100); stop_timer(&quot;t2&quot;); send_signal(&quot;a&quot;)&#39;</span>


<span class="sd">        `name`: Name of the state machine. This name is used to send signals to it, and show its state during debugging.</span>

<span class="sd">        `transitions`: A set of transitions, as explained above. There must be at least one initial transition.</span>

<span class="sd">        `obj`: An object that encapsulates any actions called from states or transitions.</span>

<span class="sd">        `states`: Optional state declarations to add entry and exit actions to them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s1">&#39;initial&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_states</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_states</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_transitions</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the current control state of the machine.</span>

<span class="sd">        This property can be accessed for debugging only.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of this machine.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">driver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the driver this machine is attached to.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span>

    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s1">&#39;initial&#39;</span>

    <span class="k">def</span> <span class="nf">_run_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">function_name</span> <span class="o">=</span> <span class="n">function_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Running function {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Error when running function {} from machine.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">function_name</span><span class="p">),</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_state_machine_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;start_timer&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Method {} expects 2 args.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_timer</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;stop_timer&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Method {} expects 1 arg.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_timer</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Action {} is not a built-in method.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">=</span> <span class="n">scheduler</span>

    <span class="k">def</span> <span class="nf">_run_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_state_machine_method</span><span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_state_machine_function</span><span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;event_args&#39;</span><span class="p">]:</span>
                <span class="c1"># use the arguments provided by the event</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">,</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># use the static arguments provided by declaration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">,</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span> <span class="p">{})</span>

    <span class="k">def</span> <span class="nf">_enter_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Machine {} enters state {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
        <span class="c1"># execute any entry actions</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_actions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">[</span><span class="n">state</span><span class="p">]</span><span class="o">.</span><span class="n">entry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">_exit_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Machine {} exits state {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
        <span class="c1"># execute any exit actions</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_actions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">[</span><span class="n">state</span><span class="p">]</span><span class="o">.</span><span class="n">exit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">is</span> <span class="s1">&#39;initial&#39;</span><span class="p">:</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intial_transition</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t_id</span> <span class="o">=</span> <span class="n">_tid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="n">event_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Machine {} is in state {} and received &#39;</span>
                    <span class="s1">&#39;event {}, but no transition with this event is declared!&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">transition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">[</span><span class="n">t_id</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exit_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>
        <span class="c1"># execute all effects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_actions</span><span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="n">effect</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transition</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
            <span class="c1"># simple transition</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">transition</span><span class="o">.</span><span class="n">target</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># compound transitions defined in code</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">transition</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># go into the next state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enter_state</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Transition in {} from {} to {} triggered by {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">previous_state</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">event_id</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">start_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timer_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start a timer or restart an active one.</span>

<span class="sd">        The timeout is given in milliseconds. If a timer with the</span>
<span class="sd">        same name already exists, it is restarted with the specified timeout.</span>
<span class="sd">        Note that the timeout is intended as the minimum time until the timer&#39;s</span>
<span class="sd">        expiration, but may vary due to the state of the event queue and the</span>
<span class="sd">        load of the system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start timer {}in stm {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_start_timer</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timer_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop a timer.</span>

<span class="sd">        If the timer is not active, nothing happens.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stop timer {}in stm {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_stop_timer</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timer_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the remaining time for the timer.</span>

<span class="sd">        If the timer is not active, `None` is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_get_timer</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_id</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a signal to this state machine.</span>

<span class="sd">        To send a signal to a machine by its name, use</span>
<span class="sd">        `stmpy.Driver.send_signal` instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Send signal {}in stm {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signal_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span>
            <span class="n">event_id</span><span class="o">=</span><span class="n">signal_id</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">stm</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminate this state machine.</span>

<span class="sd">        This removes it from the scheduler.</span>
<span class="sd">        If this is the last state machine of the scheduler and the scheduler is</span>
<span class="sd">        not configured to stay active, this will also terminate the scheduler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_terminate_stm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#stmpy.Machine">Machine</a></li>
          <li>builtins.object</li>
          </ul>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="stmpy.Machine.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, name, transitions, obj, states=[])</p>
    </div>
    

    
  
    <div class="desc"><p>Create a new state machine.</p>
<p>Throws an exception if the state machine is not well-formed.</p>
<p><strong>Transitions:</strong>
Transitions are specified as a dictionary with the following key / value
pairs:</p>
<ul>
<li>trigger: string with the name of a trigger, either a signal to receive or the name of a timer.</li>
<li>source: string with the name of a state.</li>
<li>target: string with the name of a state.</li>
<li>
<p>effect: (optional) a set of strings that refers to method name of the object passed to the state machine via <code>obj</code>. Several effects can be separated with a <code>;</code>.</p>
<h1>!python</h1>
<p>t_1 = {'trigger': 'tick',
       'source': 's_tick',
       'target': 's_tock',
       'effect': 'on_tick'}</p>
</li>
</ul>
<p><strong>Initial Transition:</strong>
A state machine requires a single initial transition. This is a normal
transition that has a source state with name <code>'initial'</code>, and no
trigger.</p>
<div class="codehilite"><pre><span></span><span class="n">t_0</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;initial&#39;</span><span class="p">,</span>
       <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;s_tick&#39;</span><span class="p">,</span>
       <span class="s1">&#39;effect&#39;</span><span class="p">:</span> <span class="s1">&#39;on_init&#39;</span><span class="p">}</span>
</pre></div>


<p><strong>Compound Transitions:</strong>
A compound transition is used to declare a transition that can contain decisions.
A compound transition can decide upon the target state at run-time, for instance based on data in variables.
It is declared like a normal transition, but does not declare any effect or target.
Instead, it refers to a function that is executed. The function must return a string that determines the target state.
The key 'targets' (notice the plural 's') allows to specify the potential target states.
This has no influence on the behavior of the state machine, but is just used when the data structure is also
used to generate a state machine graph.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">transition_1</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># do something</span>
    <span class="k">if</span> <span class="o">...</span> <span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;s1&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;s2&#39;</span>

<span class="n">t_3</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;s_0&#39;</span><span class="p">,</span>
       <span class="s1">&#39;trigger&#39;</span><span class="p">:</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span>
       <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="s1">&#39;s1 s2&#39;</span><span class="p">,</span>
       <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="n">transition_1</span><span class="p">}</span>
</pre></div>


<p><strong>States:</strong>
States are specified as sources and targets as part of the transitions.
This is done by simple strings.</p>
<p>States can also declare entry and exit actions that are called when they are entered or exited.
To declare these actions, declare a dictionary for the state. The name key refers to
the name of the state that is also used in the transition declaration.</p>
<div class="codehilite"><pre><span></span><span class="n">s_0</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;s_0&#39;</span><span class="p">,</span>
       <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="s1">&#39;op1; op2&#39;</span><span class="p">,</span>
       <span class="s1">&#39;exit&#39;</span><span class="p">:</span> <span class="s1">&#39;op3&#39;</span><span class="p">}</span>
</pre></div>


<p><strong>Actions and Effects:</strong>
The value of the attributes for transition effects and for state entry
and exit actions can list several actions that are called on the object
provided to the state machine.</p>
<p>This list of actions can look in the following way:</p>
<div class="codehilite"><pre><span></span>effect=&#39;m1; m2(); m3(1, True, &quot;a&quot;); m4(*)&#39;
</pre></div>


<p>This is a semicolon-separated list of actions that are called, here as
part of a transition's effect. Method m1 has no arguments, and neither
does m2. This means the empty brackets are optional. Method m3 has three
litteral arguments, here the integer 1, the boolean True and the string
'a'. Note how the string is surrounded by double quotation marks, since
the entire effect is coded in single quotation marks. Vice-versa is also
possible. The last method, m4, declares an asterisk as argument. This
means that the state machine uses the args and kwargs of the incoming
event and offers them to the method.</p>
<p>The actions can also directly refer to the state machine actions
<a href="#stmpy.Machine.start_timer"><code>start_timer</code></a>, <a href="#stmpy.Machine.stop_timer"><code>stop_timer</code></a>, and
<a href="#stmpy.Machine.send_signal"><code>send_signal</code></a>. A transition can for instance declare the
following effects:</p>
<div class="codehilite"><pre><span></span>effect=&#39;start_timer(&quot;t1&quot;, 100); stop_timer(&quot;t2&quot;); send_signal(&quot;a&quot;)&#39;
</pre></div>


<p><code>name</code>: Name of the state machine. This name is used to send signals to it, and show its state during debugging.</p>
<p><code>transitions</code>: A set of transitions, as explained above. There must be at least one initial transition.</p>
<p><code>obj</code>: An object that encapsulates any actions called from states or transitions.</p>
<p><code>states</code>: Optional state declarations to add entry and exit actions to them.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Machine.__init__', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Machine.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Create a new state machine.</span>
<span class="sd">    Throws an exception if the state machine is not well-formed.</span>
<span class="sd">    **Transitions:**</span>
<span class="sd">    Transitions are specified as a dictionary with the following key / value</span>
<span class="sd">    pairs:</span>
<span class="sd">      * trigger: string with the name of a trigger, either a signal to receive or the name of a timer.</span>
<span class="sd">      * source: string with the name of a state.</span>
<span class="sd">      * target: string with the name of a state.</span>
<span class="sd">      * effect: (optional) a set of strings that refers to method name of the object passed to the state machine via `obj`. Several effects can be separated with a `;`.</span>
<span class="sd">        #!python</span>
<span class="sd">        t_1 = {&#39;trigger&#39;: &#39;tick&#39;,</span>
<span class="sd">               &#39;source&#39;: &#39;s_tick&#39;,</span>
<span class="sd">               &#39;target&#39;: &#39;s_tock&#39;,</span>
<span class="sd">               &#39;effect&#39;: &#39;on_tick&#39;}</span>
<span class="sd">    **Initial Transition:**</span>
<span class="sd">    A state machine requires a single initial transition. This is a normal</span>
<span class="sd">    transition that has a source state with name `&#39;initial&#39;`, and no</span>
<span class="sd">    trigger.</span>
<span class="sd">        #!python</span>
<span class="sd">        t_0 = {&#39;source&#39;: &#39;initial&#39;,</span>
<span class="sd">               &#39;target&#39;: &#39;s_tick&#39;,</span>
<span class="sd">               &#39;effect&#39;: &#39;on_init&#39;}</span>
<span class="sd">    **Compound Transitions:**</span>
<span class="sd">    A compound transition is used to declare a transition that can contain decisions.</span>
<span class="sd">    A compound transition can decide upon the target state at run-time, for instance based on data in variables.</span>
<span class="sd">    It is declared like a normal transition, but does not declare any effect or target.</span>
<span class="sd">    Instead, it refers to a function that is executed. The function must return a string that determines the target state.</span>
<span class="sd">    The key &#39;targets&#39; (notice the plural &#39;s&#39;) allows to specify the potential target states.</span>
<span class="sd">    This has no influence on the behavior of the state machine, but is just used when the data structure is also</span>
<span class="sd">    used to generate a state machine graph.</span>
<span class="sd">        #!python</span>
<span class="sd">        def transition_1(args, kwargs):</span>
<span class="sd">            # do something</span>
<span class="sd">            if ... :</span>
<span class="sd">                return &#39;s1&#39;</span>
<span class="sd">            else:</span>
<span class="sd">                return &#39;s2&#39;</span>
<span class="sd">        t_3 = {&#39;source&#39;: &#39;s_0&#39;,</span>
<span class="sd">               &#39;trigger&#39;: &#39;t&#39;,</span>
<span class="sd">               &#39;targets&#39;: &#39;s1 s2&#39;,</span>
<span class="sd">               &#39;function&#39;: transition_1}</span>
<span class="sd">    **States:**</span>
<span class="sd">    States are specified as sources and targets as part of the transitions.</span>
<span class="sd">    This is done by simple strings.</span>
<span class="sd">    States can also declare entry and exit actions that are called when they are entered or exited.</span>
<span class="sd">    To declare these actions, declare a dictionary for the state. The name key refers to</span>
<span class="sd">    the name of the state that is also used in the transition declaration.</span>
<span class="sd">        #!python</span>
<span class="sd">        s_0 = {&#39;name&#39;: &#39;s_0&#39;,</span>
<span class="sd">               &#39;entry&#39;: &#39;op1; op2&#39;,</span>
<span class="sd">               &#39;exit&#39;: &#39;op3&#39;}</span>
<span class="sd">    **Actions and Effects:**</span>
<span class="sd">    The value of the attributes for transition effects and for state entry</span>
<span class="sd">    and exit actions can list several actions that are called on the object</span>
<span class="sd">    provided to the state machine.</span>
<span class="sd">    This list of actions can look in the following way:</span>
<span class="sd">        effect=&#39;m1; m2(); m3(1, True, &quot;a&quot;); m4(*)&#39;</span>
<span class="sd">    This is a semicolon-separated list of actions that are called, here as</span>
<span class="sd">    part of a transition&#39;s effect. Method m1 has no arguments, and neither</span>
<span class="sd">    does m2. This means the empty brackets are optional. Method m3 has three</span>
<span class="sd">    litteral arguments, here the integer 1, the boolean True and the string</span>
<span class="sd">    &#39;a&#39;. Note how the string is surrounded by double quotation marks, since</span>
<span class="sd">    the entire effect is coded in single quotation marks. Vice-versa is also</span>
<span class="sd">    possible. The last method, m4, declares an asterisk as argument. This</span>
<span class="sd">    means that the state machine uses the args and kwargs of the incoming</span>
<span class="sd">    event and offers them to the method.</span>
<span class="sd">    The actions can also directly refer to the state machine actions</span>
<span class="sd">    `stmpy.Machine.start_timer`, `stmpy.Machine.stop_timer`, and</span>
<span class="sd">    `stmpy.Machine.send_signal`. A transition can for instance declare the</span>
<span class="sd">    following effects:</span>
<span class="sd">        effect=&#39;start_timer(&quot;t1&quot;, 100); stop_timer(&quot;t2&quot;); send_signal(&quot;a&quot;)&#39;</span>
<span class="sd">    `name`: Name of the state machine. This name is used to send signals to it, and show its state during debugging.</span>
<span class="sd">    `transitions`: A set of transitions, as explained above. There must be at least one initial transition.</span>
<span class="sd">    `obj`: An object that encapsulates any actions called from states or transitions.</span>
<span class="sd">    `states`: Optional state declarations to add entry and exit actions to them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s1">&#39;initial&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">obj</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_states</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_states</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_transitions</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="stmpy.Machine.get_timer">
    <p>def <span class="ident">get_timer</span>(</p><p>self, timer_id)</p>
    </div>
    

    
  
    <div class="desc"><p>Gets the remaining time for the timer.</p>
<p>If the timer is not active, <code>None</code> is returned.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Machine.get_timer', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Machine.get_timer" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timer_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the remaining time for the timer.</span>
<span class="sd">    If the timer is not active, `None` is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_get_timer</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="stmpy.Machine.send_signal">
    <p>def <span class="ident">send_signal</span>(</p><p>self, signal_id, args=[], kwargs={})</p>
    </div>
    

    
  
    <div class="desc"><p>Send a signal to this state machine.</p>
<p>To send a signal to a machine by its name, use
<a href="#stmpy.Driver.send_signal"><code>send_signal</code></a> instead.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Machine.send_signal', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Machine.send_signal" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">send_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_id</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a signal to this state machine.</span>
<span class="sd">    To send a signal to a machine by its name, use</span>
<span class="sd">    `stmpy.Driver.send_signal` instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Send signal {}in stm {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signal_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span>
        <span class="n">event_id</span><span class="o">=</span><span class="n">signal_id</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">stm</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="stmpy.Machine.start_timer">
    <p>def <span class="ident">start_timer</span>(</p><p>self, timer_id, timeout)</p>
    </div>
    

    
  
    <div class="desc"><p>Start a timer or restart an active one.</p>
<p>The timeout is given in milliseconds. If a timer with the
same name already exists, it is restarted with the specified timeout.
Note that the timeout is intended as the minimum time until the timer's
expiration, but may vary due to the state of the event queue and the
load of the system.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Machine.start_timer', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Machine.start_timer" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">start_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timer_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start a timer or restart an active one.</span>
<span class="sd">    The timeout is given in milliseconds. If a timer with the</span>
<span class="sd">    same name already exists, it is restarted with the specified timeout.</span>
<span class="sd">    Note that the timeout is intended as the minimum time until the timer&#39;s</span>
<span class="sd">    expiration, but may vary due to the state of the event queue and the</span>
<span class="sd">    load of the system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start timer {}in stm {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_start_timer</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="stmpy.Machine.stop_timer">
    <p>def <span class="ident">stop_timer</span>(</p><p>self, timer_id)</p>
    </div>
    

    
  
    <div class="desc"><p>Stop a timer.</p>
<p>If the timer is not active, nothing happens.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Machine.stop_timer', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Machine.stop_timer" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">stop_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timer_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stop a timer.</span>
<span class="sd">    If the timer is not active, nothing happens.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stop timer {}in stm {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_stop_timer</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="stmpy.Machine.terminate">
    <p>def <span class="ident">terminate</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Terminate this state machine.</p>
<p>This removes it from the scheduler.
If this is the last state machine of the scheduler and the scheduler is
not configured to stay active, this will also terminate the scheduler.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-stmpy.Machine.terminate', this);">Show source &equiv;</a></p>
  <div id="source-stmpy.Machine.terminate" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Terminate this state machine.</span>
<span class="sd">    This removes it from the scheduler.</span>
<span class="sd">    If this is the last state machine of the scheduler and the scheduler is</span>
<span class="sd">    not configured to stay active, this will also terminate the scheduler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">_terminate_stm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
          <h3>Instance variables</h3>
            <div class="item">
            <p id="stmpy.Machine.driver" class="name">var <span class="ident">driver</span></p>
            

            
  
    <div class="desc"><p>Return the driver this machine is attached to.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="stmpy.Machine.id" class="name">var <span class="ident">id</span></p>
            

            
  
    <div class="desc"><p>Return the name of this machine.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="stmpy.Machine.state" class="name">var <span class="ident">state</span></p>
            

            
  
    <div class="desc"><p>Return the current control state of the machine.</p>
<p>This property can be accessed for debugging only.</p></div>
  <div class="source_cont">
</div>

            </div>
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
